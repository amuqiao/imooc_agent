# LangChain å¤šè½®å¯¹è¯èƒ½åŠ›å®ç°

## ğŸ“ å®ç°æ–‡ä»¶

### æ ¸å¿ƒå®ç°æ–‡ä»¶
- **multi_turn_conversation.py**ï¼šå®ç°å¤šè½®å¯¹è¯æ ¸å¿ƒåŠŸèƒ½
- **demo_multi_turn.py**ï¼šäº¤äº’å¼æ¼”ç¤ºè„šæœ¬

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾
```mermaid
graph TD
    %% æ ·å¼å®šä¹‰ï¼ˆå…¨å±€ç»Ÿä¸€ï¼‰
    classDef userInputStyle fill:#FF6B6B,stroke:#2D3436,stroke-width:3px,color:white,rx:8,ry:8
    classDef historyLayerStyle fill:#4ECDC4,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8
    classDef promptLayerStyle fill:#45B7D1,stroke:#2D3436,stroke-width:2px,color:white,rx:8,ry:8
    classDef chainLayerStyle fill:#96CEB4,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8
    classDef llmLayerStyle fill:#FF9FF3,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8
    classDef outputLayerStyle fill:#54A0FF,stroke:#2D3436,stroke-width:2px,color:white,rx:8,ry:8
    classDef noteStyle fill:#E9ECEF,stroke:#2D3436,stroke-width:3px,color:#2D3436,rx:8,ry:8
    classDef updateStyle fill:#FECA57,stroke:#2D3436,stroke-width:2px,color:#2D3436,rx:8,ry:8

    %% ç¬¬ä¸€å±‚ï¼šç”¨æˆ·è¾“å…¥ä¸ä¼šè¯æ ‡è¯†
    A["ç”¨æˆ·è¾“å…¥<br/>ï¼ˆsession_id + å½“å‰é—®é¢˜ï¼‰"]:::userInputStyle -->|æºå¸¦ï¼šsession_idã€ç”¨æˆ·é—®é¢˜æ–‡æœ¬| B["get_session_history(session_id)"]:::historyLayerStyle
    
    %% å­å›¾1ï¼šå†å²å¯¹è¯å­˜å‚¨å±‚
    subgraph å†å²å¯¹è¯å­˜å‚¨å±‚
        B -->|è¿”å›ï¼šè¯¥sessionä¸“å±å®ä¾‹| C["ChatMessageHistory<br/>ï¼ˆå­˜å‚¨å†å²å¯¹è¯ï¼‰"]:::historyLayerStyle
        C -->|å¯é€‰ï¼šåŠ è½½å†å²| P["Persistent Storage<br/>ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰"]:::historyLayerStyle
        P -->|å¯é€‰ï¼šå­˜å‚¨å†å²| C
        note1["ğŸ“Œ session_idï¼šä¼šè¯å”¯ä¸€æ ‡è¯†"]:::noteStyle -.-> B
    end

    %% å­å›¾2ï¼šæç¤ºè¯æ„å»ºå±‚
    subgraph æç¤ºè¯æ„å»ºå±‚
        D["ChatPromptTemplate<br/>ï¼ˆå¯¹è¯æç¤ºæ¨¡æ¿ï¼‰"]:::promptLayerStyle -->|åŒ…å«ï¼šMessages Placeholder å ä½ç¬¦| E["Messages Placeholder<br/>ï¼ˆ{chat_history} å ä½ç¬¦ï¼‰"]:::promptLayerStyle
        C -->|æ³¨å…¥ï¼šå†å²å¯¹è¯æ¶ˆæ¯åˆ—è¡¨| E
        E -->|ç”Ÿæˆï¼šå¸¦å†å²çš„å®Œæ•´æç¤ºè¯| F["ç»„è£…åæç¤ºè¯"]:::promptLayerStyle
    end

    %% å­å›¾3ï¼šLCEL é“¾å¼è°ƒç”¨å±‚
    subgraph LCEL é“¾å¼è°ƒç”¨å±‚
        F -->|ä¼ å…¥ï¼šå®Œæ•´æç¤ºè¯| G["RunnableWithMessageHistory<br/>ï¼ˆåŒ…è£…LCEL Chainï¼‰"]:::chainLayerStyle
        G -->|è°ƒç”¨ï¼šå¤§æ¨¡å‹æ¥å£| H["LLM<br/>ï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰"]:::llmLayerStyle
        H -->|è¿”å›ï¼šæ¨¡å‹ç»“æ„åŒ–è¾“å‡º| I["StrOutputParser<br/>ï¼ˆè§£æä¸ºå­—ç¬¦ä¸²ï¼‰"]:::outputLayerStyle
    end

    %% ç»“æœè¿”å›ä¸å†å²æ›´æ–°
    I -->|è¿”å›ï¼šæœ€ç»ˆå›ç­”æ–‡æœ¬| J["ç”¨æˆ·æ¥æ”¶å›ç­”"]:::userInputStyle
    I -->|å­˜å…¥ï¼šæœ¬è½®é—®ç­”ï¼ˆç”¨æˆ·+åŠ©æ‰‹ï¼‰| C:::updateStyle
    C -->|å¯é€‰ï¼šæŒä¹…åŒ–æ›´æ–°| P:::updateStyle

    %% æ ¸å¿ƒå¤‡æ³¨
    note2["ğŸ“Œ æ ¸å¿ƒé€»è¾‘ï¼šå†å²æ³¨å…¥ â†’ æ¨¡å‹è°ƒç”¨ â†’ å†å²æ›´æ–° â†’ å¯é€‰æŒä¹…åŒ–"]:::noteStyle -.-> G
```

### ä»£ç æ¶æ„

```
â”œâ”€â”€ ConversationConfig (é…ç½®ç®¡ç†)
â”‚   â”œâ”€â”€ enable_persistence: æŒä¹…åŒ–å¼€å…³ï¼ˆå¸ƒå°”å€¼ï¼‰
â”‚   â”œâ”€â”€ data_dir: å­˜å‚¨ç›®å½•è·¯å¾„
â”‚   â””â”€â”€ session_prefix: ä¼šè¯IDå‰ç¼€
â”‚   â”œâ”€â”€ å·¥å‚æ–¹æ³•: with_persistence() / in_memory()
â”‚
â”œâ”€â”€ ConversationStore (å­˜å‚¨ç®¡ç†)
â”‚   â”œâ”€â”€ å†…å­˜æ¨¡å¼: Dict[str, ChatMessageHistory]
â”‚   â””â”€â”€ æŒä¹…åŒ–æ¨¡å¼: FileChatMessageHistory + JSONæ–‡ä»¶
â”‚   â”œâ”€â”€ æ ¸å¿ƒæ–¹æ³•: get_session_history()
â”‚
â””â”€â”€ MultiTurnConversationManager (æ ¸å¿ƒç®¡ç†å™¨)
    â”œâ”€â”€ ä¾èµ–: RunnableWithMessageHistoryï¼ˆLCELé“¾å°è£…ï¼‰
    â”œâ”€â”€ æ ¸å¿ƒAPI:
    â”‚   â”œâ”€â”€ create_session(): åˆ›å»ºæ–°ä¼šè¯
    â”‚   â”œâ”€â”€ chat(): å‘é€æ¶ˆæ¯å¹¶è·å–å›å¤
    â”‚   â”œâ”€â”€ get_history(): è·å–å¯¹è¯å†å²
    â”‚   â””â”€â”€ clear_history(): æ¸…ç©ºå†å²
    â””â”€â”€ è¾…åŠ©æ–¹æ³•: get_chain_with_history()
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# ç¡®ä¿å·²å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt
# æˆ–ä½¿ç”¨uv
uv sync
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¤ºä¾‹ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œæ·»åŠ å¿…è¦çš„APIå¯†é’¥
```

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. æŒä¹…åŒ–å¼€å…³

```python
from app.bailian.multi_turn_conversation import create_conversation_manager

# å†…å­˜æ¨¡å¼ï¼ˆä¸æ”¯æŒæŒä¹…åŒ–ï¼‰
manager = create_conversation_manager(enable_persistence=False)

# æŒä¹…åŒ–æ¨¡å¼
manager = create_conversation_manager(
    enable_persistence=True,
    data_dir="data/conversations"
)
```

### 2. ä¾¿æ·é…ç½®æ–¹æ³•

```python
from app.bailian.multi_turn_conversation import ConversationConfig

# å†…å­˜é…ç½®
config = ConversationConfig.in_memory()

# æŒä¹…åŒ–é…ç½®
config = ConversationConfig.with_persistence("data/conversations")

# è‡ªå®šä¹‰é…ç½®
config = ConversationConfig(
    enable_persistence=True,
    data_dir="custom/path",
    session_prefix="user"
)
```

### 3. å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

```python
from app.bailian.multi_turn_conversation import create_conversation_manager

# åˆ›å»ºå¯¹è¯ç®¡ç†å™¨
manager = create_conversation_manager(
    enable_persistence=True,  # å¼€å¯æŒä¹…åŒ–
    data_dir="data/conversations",  # å­˜å‚¨ç›®å½•
    system_prompt="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šåŠ©æ‰‹ï¼Œæ“…é•¿å›ç­”å„ç§é—®é¢˜ã€‚"  # ç³»ç»Ÿæç¤ºè¯
)

# åˆ›å»ºä¼šè¯
session_id = manager.create_session()
print(f"ä¼šè¯ID: {session_id}")

# å¤šè½®å¯¹è¯
response1 = manager.chat("ä½ å¥½ï¼", session_id)
print(f"åŠ©æ‰‹: {response1}")

response2 = manager.chat("å¸®æˆ‘å†™ä¸ªPythonå¿«é€Ÿæ’åºç®—æ³•", session_id)
print(f"åŠ©æ‰‹: {response2}")

# è·å–å¯¹è¯å†å²
history = manager.get_history(session_id)
print("\nå¯¹è¯å†å²:")
for msg in history:
    print(f"{msg['role']}: {msg['content']}")
```

## ğŸ“– API å‚è€ƒ

### MultiTurnConversationManager

#### åˆ›å»ºå¯¹è¯ç®¡ç†å™¨

```python
def create_conversation_manager(
    enable_persistence: bool = False,
    data_dir: str = "data/conversations",
    system_prompt: Optional[str] = None
) -> MultiTurnConversationManager:
    """åˆ›å»ºå¯¹è¯ç®¡ç†å™¨
    
    Args:
        enable_persistence: æ˜¯å¦å¯ç”¨æŒä¹…åŒ–å­˜å‚¨
        data_dir: æŒä¹…åŒ–å­˜å‚¨ç›®å½•
        system_prompt: ç³»ç»Ÿæç¤ºè¯
    
    Returns:
        MultiTurnConversationManager å®ä¾‹
    """
```

#### åˆ›å»ºä¼šè¯

```python
def create_session(self, session_id: Optional[str] = None) -> str:
    """åˆ›å»ºæ–°ä¼šè¯
    
    Args:
        session_id: è‡ªå®šä¹‰ä¼šè¯IDï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆ
    
    Returns:
        ä¼šè¯IDå­—ç¬¦ä¸²
    """
```

#### å‘é€æ¶ˆæ¯

```python
def chat(self, question: str, session_id: str, auto_save: bool = True) -> str:
    """å‘é€æ¶ˆæ¯å¹¶è·å–å›å¤
    
    Args:
        question: ç”¨æˆ·é—®é¢˜
        session_id: ä¼šè¯ID
        auto_save: æ˜¯å¦è‡ªåŠ¨ä¿å­˜å¯¹è¯å†å²ï¼ˆé»˜è®¤ï¼šTrueï¼‰
    
    Returns:
        åŠ©æ‰‹å›å¤å­—ç¬¦ä¸²
    """
```

#### è·å–å¯¹è¯å†å²

```python
def get_history(self, session_id: str) -> list:
    """è·å–å¯¹è¯å†å²
    
    Args:
        session_id: ä¼šè¯ID
    
    Returns:
        å¯¹è¯å†å²åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«roleå’Œcontentå­—æ®µ
    """
```

#### æ¸…ç©ºå¯¹è¯å†å²

```python
def clear_history(self, session_id: str) -> None:
    """æ¸…ç©ºå¯¹è¯å†å²
    
    Args:
        session_id: ä¼šè¯ID
    """
```

## ğŸ§ª è¿è¡Œæµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python app/bailian/test_multi_turn_conversation.py --test
```

### äº¤äº’å¼æ¼”ç¤º

```bash
# è¿è¡Œå¯¹è¯ç¤ºä¾‹
python app/bailian/multi_turn_conversation.py

# è¿è¡ŒæŒä¹…åŒ–å¼€å…³æ¼”ç¤º
python app/bailian/multi_turn_conversation.py --demo

# è¿è¡Œäº¤äº’å¼æ¼”ç¤ºè„šæœ¬
python app/bailian/demo_multi_turn.py
```

## ğŸ“„ æŒä¹…åŒ–å­˜å‚¨

### å­˜å‚¨æ ¼å¼

å¯¹è¯å†å²å­˜å‚¨åœ¨ `data/conversations/{user_id}/{session_id}.json` æ–‡ä»¶ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```json
[
  {
    "type": "human",
    "data": {
      "content": "ä½ å¥½",
      "additional_kwargs": {},
      "type": "human"
    }
  },
  {
    "type": "ai",
    "data": {
      "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ",
      "additional_kwargs": {},
      "type": "ai"
    }
  }
]
```

### ç›®å½•ç»“æ„

```
data/
â””â”€â”€ conversations/
    â””â”€â”€ session/          # æ ¹æ®session_idå‰ç¼€è‡ªåŠ¨åˆ›å»º
        â””â”€â”€ session_xxx.json  # ä¼šè¯IDå¯¹åº”çš„JSONæ–‡ä»¶
```

## ğŸ”§ é…ç½®é€‰é¡¹

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|-------|------|--------|------|
| enable_persistence | bool | False | æ˜¯å¦å¯ç”¨æŒä¹…åŒ–å­˜å‚¨ |
| data_dir | str | "data/conversations" | æŒä¹…åŒ–å­˜å‚¨ç›®å½• |
| session_prefix | str | "session" | ä¼šè¯IDå‰ç¼€ |
| system_prompt | str | "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹..." | ç³»ç»Ÿæç¤ºè¯ |

## ğŸŒŸ ç‰¹æ€§äº®ç‚¹

1. **çµæ´»çš„æŒä¹…åŒ–é€‰é¡¹**ï¼šå¯éšæ—¶åˆ‡æ¢å†…å­˜æ¨¡å¼å’ŒæŒä¹…åŒ–æ¨¡å¼
2. **ç®€å•æ˜“ç”¨çš„API**ï¼šæä¾›ç®€æ´çš„æ¥å£ï¼Œæ˜“äºé›†æˆåˆ°ç°æœ‰é¡¹ç›®
3. **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¼šè¯å¹¶å‘ï¼Œæ¯ä¸ªä¼šè¯ç‹¬ç«‹å­˜å‚¨
4. **å®Œæ•´çš„æµ‹è¯•è¦†ç›–**ï¼šåŒ…å«å•å…ƒæµ‹è¯•å’Œæ¼”ç¤ºè„šæœ¬
5. **LangChain 1.2.4 å…¼å®¹**ï¼šä¸é¡¹ç›®ä¸­ä½¿ç”¨çš„LangChainç‰ˆæœ¬å®Œå…¨å…¼å®¹
6. **æ¨¡å—åŒ–è®¾è®¡**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **APIå¯†é’¥é…ç½®**ï¼šä½¿ç”¨å‰éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ç›¸åº”çš„APIå¯†é’¥
2. **å­˜å‚¨ç›®å½•æƒé™**ï¼šç¡®ä¿ç¨‹åºå¯¹æŒä¹…åŒ–å­˜å‚¨ç›®å½•æœ‰è¯»å†™æƒé™
3. **ä¼šè¯IDå”¯ä¸€æ€§**ï¼šæ¯ä¸ªä¼šè¯IDåº”å”¯ä¸€ï¼Œé¿å…å†²çª
4. **å¤§æ¨¡å‹è´¹ç”¨**ï¼šä½¿ç”¨å¤§æ¨¡å‹ä¼šäº§ç”Ÿè´¹ç”¨ï¼Œè¯·åˆç†ä½¿ç”¨
5. **å†å²è®°å½•å¤§å°**ï¼šé•¿æ—¶é—´å¯¹è¯ä¼šå¯¼è‡´å†å²è®°å½•å˜å¤§ï¼Œå¯èƒ½å½±å“æ€§èƒ½

## ğŸš€ æ‰©å±•å»ºè®®

1. **æ·»åŠ å¯¹è¯æ‘˜è¦åŠŸèƒ½**ï¼šå¯¹é•¿å¯¹è¯è¿›è¡Œæ‘˜è¦ï¼Œå‡å°‘å†å²è®°å½•å¤§å°
2. **æ”¯æŒå¤šç§å­˜å‚¨åç«¯**ï¼šå¦‚æ•°æ®åº“ã€äº‘å­˜å‚¨ç­‰
3. **æ·»åŠ å¯¹è¯æœç´¢åŠŸèƒ½**ï¼šæ”¯æŒæœç´¢å†å²å¯¹è¯
4. **å®ç°å¯¹è¯å¯¼å‡ºåŠŸèƒ½**ï¼šæ”¯æŒå°†å¯¹è¯å¯¼å‡ºä¸ºJSONã€Markdownç­‰æ ¼å¼
5. **æ·»åŠ ç”¨æˆ·è®¤è¯**ï¼šå®ç°ç”¨æˆ·çº§åˆ«çš„å¯¹è¯ç®¡ç†

## ğŸ† æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®ä¼šè¯è¶…æ—¶**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
2. **ä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯**ï¼šæ ¹æ®å…·ä½“åœºæ™¯è°ƒæ•´ç³»ç»Ÿæç¤ºè¯
3. **ç›‘æ§å­˜å‚¨ä½¿ç”¨**ï¼šå®šæœŸæ£€æŸ¥å­˜å‚¨ç›®å½•å¤§å°
4. **å¤‡ä»½é‡è¦å¯¹è¯**ï¼šå¯¹é‡è¦å¯¹è¯è¿›è¡Œå®šæœŸå¤‡ä»½
5. **é™æµæªæ–½**ï¼šæ·»åŠ APIè°ƒç”¨é™æµï¼Œé¿å…è¿‡åº¦ä½¿ç”¨

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤Issueæˆ–è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

---

**æ›´æ–°æ—¶é—´**ï¼š2026-01-20
**ç‰ˆæœ¬**ï¼š1.0.0
**ä½œè€…**ï¼šLangChain å¼€å‘å›¢é˜Ÿ